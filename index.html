<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <title>æ‹ã®ã‚ªãƒ©ã‚¯ãƒ« AIæ‹æ˜Ÿè­š</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        /* CSSã¯ä»¥å‰ã®ã¾ã¾å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“ */
        :root {
            --primary-color: #ff69b4;
            --background-color: #fff0f5;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        .container {
            max-width: 700px;
            width: 100%;
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
        }
        h1, h2, h3 { color: var(--primary-color); text-align: center; transition: color 0.3s; }
        h1 { font-size: 2em; }
        h2 { font-size: 1.5em; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; margin-top: 30px; transition: border-color 0.3s; }
        /* ç”»é¢è¡¨ç¤ºç”¨ã«h3ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ */
        .result-content h3 { 
            text-align: left; 
            font-size: 1.3em; 
            margin-top: 25px; 
            border-bottom: 1px solid var(--primary-color);
            opacity: 0.6;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover { opacity: 0.8; }
        button:disabled { background-color: #ccc; cursor: not-allowed; opacity: 1; }
        .hidden { display: none; }
        
        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #result-area, #chart-container { 
            margin-top: 20px; 
            padding: 20px; 
            background: #f9f9f9; 
            border-radius: var(--border-radius); 
            white-space: pre-wrap; 
            word-wrap: break-word;
            line-height: 1.65; 
            font-size: 1.05em;
        }
        /* HTMLå´ã®å¼·èª¿è¡¨ç¤ºï¼ˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
        #result-area strong {
            background: linear-gradient(transparent 70%, var(--primary-color) 70%);
            font-weight: bold;
            padding: 0 2px;
            opacity: 0.5; /* å°‘ã—è–„ãã—ã¦èª­ã¿ã‚„ã™ã */
        }
        
        #logout-button {
            position: static; 
            width: 100%; 
            margin-top: 30px;
            padding: 12px;
            background-color: #999;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 1.0em;
            font-weight: bold;
            cursor: pointer;
            top: auto; right: auto; box-shadow: none; z-index: auto;
        }
        #logout-button:hover { background-color: #666; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message { color: red; font-weight: bold; text-align: center; margin: 10px 0; }
        .success-message { color: green; font-weight: bold; text-align: center; margin: 10px 0; }
        
        .accordion {
            cursor: pointer;
            padding: 10px;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
            transition: 0.4s;
            background-color: #eee;
            color: #444;
            font-weight: bold;
            border-radius: 4px;
            margin-top: 10px;
        }
        .accordion:after {
            content: '\002B';
            color: #777;
            font-weight: bold;
            float: right;
            margin-left: 5px;
        }
        .active:after { content: "\2212"; }
        .panel {
            padding: 0 10px;
            background-color: white;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ™ æ‹ã®ã‚ªãƒ©ã‚¯ãƒ« AIæ‹æ˜Ÿè­š</h1>
        <p style="text-align:center;">- å¿ƒã®ç¾…é‡ç›¤ Edition -</p>
        <hr>

        <div id="api-key-screen" class="hidden">
            <h2>ğŸ”® AIé‘‘å®šå¸«ã¨ã®æ¥ç¶šè¨­å®š</h2>
            <p style="font-size:0.9em; color:#666;">
                é‘‘å®šã«ä½¿ç”¨ã™ã‚‹APIã‚­ãƒ¼ã¨ã€ã”è‡ªèº«ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚<br>
                ã“ã®æƒ…å ±ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€æ¬¡å›ä»¥é™ã®å…¥åŠ›ãŒä¸è¦ã«ãªã‚Šã¾ã™ã€‚
            </p>
            <input type="email" id="setup-email" placeholder="ã‚ãªãŸã®Gmailã‚¢ãƒ‰ãƒ¬ã‚¹ (ä¾‹: user@gmail.com)" style="margin-bottom: 10px;">
            <input type="password" id="api-key" placeholder="Gemini APIã‚­ãƒ¼ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„">
            <button id="api-key-button">è¨­å®šã‚’ä¿å­˜ã—ã¦å§‹ã‚ã‚‹</button>
            <p id="api-key-message" class="error-message hidden"></p>
        </div>
        
        <div id="main-app-screen" class="hidden">
            <p class="success-message">âœ¨ AIé‘‘å®šå¸«ã¨ã®æ¥ç¶šãŒå®Œäº†ã—ã¾ã—ãŸï¼</p>
            
            <h2>Step 1: é‘‘å®šã®æº–å‚™</h2>
            <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠæ™‚ã«è‰²ã‚’å¤‰ãˆã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ  -->
            <select id="character" onchange="updateThemeColor()">
                <option value="sister">1. å„ªã—ãåŒ…ã¿è¾¼ã‚€ã€ãŠå§‰ã•ã‚“ç³»</option>
                <option value="logical">2. ãƒ­ã‚¸ã‚«ãƒ«ã«é‹­ãåˆ†æã™ã‚‹ã€å°‚é–€å®¶ç³»</option>
                <option value="mysterious">3. æ˜Ÿã®è¨€è‘‰ã§èªã‚‹ã€ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ãªå ã„å¸«ç³»</option>
            </select>
            <select id="tone">
                <option>ç™’ã— 100%</option>
                <option selected>ç™’ã— 50% Ã— è«–ç† 50%</option>
                <option>å†·é™ã«ãƒ­ã‚¸ã‚«ãƒ«</option>
            </select>
            <input type="text" id="your-name" placeholder="ã‚ãªãŸã®LINEã§ã®åå‰ (ä¾‹: ã•ãã‚‰)">
            <input type="text" id="partner-name" placeholder="ãŠç›¸æ‰‹ã®LINEã§ã®åå‰ (ä¾‹: ãŸãã‚„)">
            <textarea id="counseling-text" rows="4" placeholder="ä»Šå›ã€ãŠç›¸æ‰‹ã¨ã®é–¢ä¿‚ã§ç‰¹ã«ã©ã‚“ãªã“ã¨ãŒæ°—ã«ãªã‚Šã¾ã™ã‹ï¼Ÿï¼ˆä¾‹ï¼‰æœ€è¿‘ã€è¿”ä¿¡ãŒé…ã„â€¦"></textarea>
            
            <h2>Step 2: ãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€</h2>
            
            <div style="background: #e6f7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #91d5ff;">
                <h3 style="font-size: 1.1em; margin-top:0; color:#0050b3;">ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€ï¼ˆæ¨å¥¨ï¼‰</h3>
                <p style="font-size: 0.9em; margin-bottom: 10px;">
                    ã‚¹ãƒãƒ›ã®LINEã‹ã‚‰å±¥æ­´ã‚’<strong>ã€Œã‚ãªãŸã”è‡ªèº«ã®Gmailã‚¢ãƒ‰ãƒ¬ã‚¹ã€</strong>ã¸é€ä¿¡ã—ã¦ãã ã•ã„ã€‚<br>
                    <span style="color:#666; font-size:0.8em;">(â€»è‡ªåˆ†ã‹ã‚‰è‡ªåˆ†ã¸ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹å½¢ã«ãªã‚Šã¾ã™)</span>
                    <br><br>
                    ãã®å¾Œã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å±¥æ­´ãŒè‡ªå‹•çš„ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
                    <br>
                    <span style="color: #d63031; font-size: 0.8em;">â€»ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·ã®ãŸã‚ã€èª­ã¿è¾¼ã¿ç›´å¾Œã«ãƒ¡ãƒ¼ãƒ«ã¯ã‚´ãƒŸç®±ã¸ç§»å‹•ï¼ˆã¾ãŸã¯å‰Šé™¤ï¼‰ã•ã‚Œã¾ã™ã€‚</span>
                </p>
                
                <button id="fetch-mail-button" style="background-color: #1890ff; width: 100%; white-space: nowrap;">ğŸ“© LINEãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’æ¢ã—ã¦èª­ã¿è¾¼ã‚€</button>
                <p style="font-size:0.8em; color:#666; margin-top:5px;">â€»ã‚ãªãŸã®ãƒ¡ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã«ã‚ã‚‹ã€æœ€æ–°ã®ã€Œ[LINE]ã€ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•ã§æ¢ã—ã¾ã™ã€‚</p>
                <p id="fetch-message" class="error-message hidden" style="text-align: left; margin-top: 5px;"></p>
            </div>

            <button class="accordion">ã¾ãŸã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’æ‰‹å‹•ã§è²¼ã‚Šä»˜ã‘ã‚‹</button>
            <div class="panel">
                <p style="font-size:0.9em; color:#666; margin-top:10px;">ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒã†ã¾ãã„ã‹ãªã„å ´åˆãªã©ã¯ã€ã“ã¡ã‚‰ã«ç›´æ¥è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</p>
                <textarea id="talk-data" rows="10" placeholder="ã“ã“ã«LINEã®ãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
            </div>
            
            <button id="diagnose-button" style="margin-top:20px;">ğŸ”® é‘‘å®šã‚’é–‹å§‹ã™ã‚‹</button>
            
            <button id="logout-button" class="hidden">ğŸšª è¨­å®šãƒªã‚»ãƒƒãƒˆ(ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ)</button>

            <div id="loading" class="hidden">
                <div class="spinner"></div>
                <p style="text-align:center;">æ˜Ÿã€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...âœ¨</p>
            </div>

            <div id="result-container" class="hidden">
                <h2>ğŸŒŸ é‘‘å®šçµæœ ğŸŒŸ</h2>
                <div id="chart-container"></div>
                <div id="result-area" class="result-content"></div>
                <button id="pdf-button" class="hidden">ğŸ“„ é‘‘å®šæ›¸ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = 'Owner'; 
        let currentAiResponse = ''; 
        let currentCharacter = '';
        
        // â˜…ã‚°ãƒ©ãƒ•ç”»åƒã®å–å¾—ç”¨
        let currentChartObject = null;
        let currentChartData = null;
        let currentChartOptions = null;

        const apiKeyScreen = document.getElementById('api-key-screen');
        const mainAppScreen = document.getElementById('main-app-screen');
        const loadingSpinner = document.getElementById('loading');
        const resultContainer = document.getElementById('result-container');
        const resultArea = document.getElementById('result-area');
        const chartContainer = document.getElementById('chart-container');
        const logoutButton = document.getElementById('logout-button');
        
        document.getElementById('api-key-button').addEventListener('click', handleApiKey);
        document.getElementById('diagnose-button').addEventListener('click', handleDiagnosis);
        document.getElementById('pdf-button').addEventListener('click', handlePdfDownload);
        logoutButton.addEventListener('click', handleLogout);

        // è‰²å¤‰æ›´ãƒ­ã‚¸ãƒƒã‚¯
        function updateThemeColor() {
            const select = document.getElementById('character');
            const text = select.options[select.selectedIndex].text;
            let color = "#ff69b4"; // Default Pink
            let bgColor = "#fff0f5";

            if (text.includes("ãƒ­ã‚¸ã‚«ãƒ«")) {
                color = "#1e90ff"; // Blue
                bgColor = "#f0f8ff";
            } else if (text.includes("ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹")) {
                color = "#9370db"; // Purple
                bgColor = "#f8f0ff";
            }

            // CSSå¤‰æ•°ã‚’æ›¸ãæ›ãˆã¦å³æ™‚åæ˜ 
            document.documentElement.style.setProperty('--primary-color', color);
            document.documentElement.style.setProperty('--background-color', bgColor);
        }

        function parseMarkdown(text) {
            if (!text) return "";
            let html = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            html = html.replace(/^\s*#+\s+(.*$)/gm, '<h3>$1</h3>');
            html = html.replace(/^\s*\*\*(.*?)\*\*\s*[:ï¼š]?\s*$/gm, '<h3>$1</h3>');
            html = html.replace(/^\s*[\*\-]\s+/gm, 'ãƒ»');
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/^\s*#+\s+/gm, '');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        const acc = document.getElementsByClassName("accordion");
        for (let i = 0; i < acc.length; i++) {
            acc[i].addEventListener("click", function() {
                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                if (panel.style.maxHeight) {
                    panel.style.maxHeight = null;
                } else {
                    panel.style.maxHeight = panel.scrollHeight + "px";
                } 
            });
        }

        document.getElementById('fetch-mail-button').addEventListener('click', function() {
            const msgArea = document.getElementById('fetch-message');
            const btn = document.getElementById('fetch-mail-button');
            const textarea = document.getElementById('talk-data');
            const accordionBtn = document.querySelector('.accordion');
            const panel = document.querySelector('.panel');
            const email = "dummy";

            msgArea.classList.add('hidden');
            btn.disabled = true;
            btn.textContent = "æ¢ã—ã¦ã„ã¾ã™...";

            google.script.run
                .withSuccessHandler(function(response) {
                    btn.disabled = false;
                    btn.textContent = "ğŸ“© LINEãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’æ¢ã—ã¦èª­ã¿è¾¼ã‚€";
                    if (response.success) {
                        textarea.value = response.text;
                        msgArea.textContent = "âœ… æˆåŠŸï¼ãƒ¡ãƒ¼ãƒ«ã‹ã‚‰ãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚";
                        msgArea.style.color = "green";
                        msgArea.classList.remove('hidden');
                        if (!accordionBtn.classList.contains("active")) {
                            accordionBtn.classList.add("active");
                            panel.style.maxHeight = panel.scrollHeight + "px";
                        }
                    } else {
                        msgArea.textContent = "âš ï¸ " + response.message;
                        msgArea.style.color = "red";
                        msgArea.classList.remove('hidden');
                    }
                })
                .withFailureHandler(function(err) {
                    btn.disabled = false;
                    btn.textContent = "ğŸ“© LINEãƒˆãƒ¼ã‚¯å±¥æ­´ã‚’æ¢ã—ã¦èª­ã¿è¾¼ã‚€";
                    alert("ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: " + err);
                })
                .fetchHistoryFromGmail(email);
        });

        window.addEventListener('DOMContentLoaded', function() {
            const savedApiKey = localStorage.getItem('koi_apiKey');
            const savedEmail = localStorage.getItem('koi_email');
            
            if (savedEmail && document.getElementById('setup-email')) {
                document.getElementById('setup-email').value = savedEmail;
            }

            if (savedApiKey) {
                google.script.run.testAndSaveApiKey(savedApiKey);
                showScreen(mainAppScreen);
            } else {
                showScreen(apiKeyScreen);
            }
        });

        function showScreen(screen) {
            apiKeyScreen.classList.add('hidden');
            mainAppScreen.classList.add('hidden');
            screen.classList.remove('hidden');
            if (screen === mainAppScreen || screen === apiKeyScreen) {
                logoutButton.classList.remove('hidden');
            } else {
                logoutButton.classList.add('hidden');
            }
        }

        function showLoading(isLoading) {
            loadingSpinner.classList.toggle('hidden', !isLoading);
            document.getElementById('diagnose-button').disabled = isLoading;
        }

        function handleLogout() {
            if(confirm('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\nä¿å­˜ã•ã‚ŒãŸAPIã‚­ãƒ¼ã¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                localStorage.removeItem('koi_apiKey');
                localStorage.removeItem('koi_email');
                
                // â˜…è¿½åŠ : ã‚µãƒ¼ãƒãƒ¼å´ã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆã™ (FoundationçµŒç”±)
                google.script.run.withSuccessHandler(function() {
                    location.reload();
                }).clearAllData();
            }
        }
        
        function handleApiKey() {
            const apiKeyInput = document.getElementById('api-key');
            const emailInput = document.getElementById('setup-email');
            const apiKeyButton = document.getElementById('api-key-button');
            const messageEl = document.getElementById('api-key-message');
            const apiKeyValue = apiKeyInput.value.trim();
            const emailValue = emailInput.value.trim();

            if (!emailValue) {
                messageEl.textContent = 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                messageEl.classList.remove('hidden');
                return;
            }
            if (!apiKeyValue) {
                messageEl.textContent = 'APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
                messageEl.classList.remove('hidden');
                return;
            }
            
            messageEl.classList.add('hidden');
            apiKeyInput.disabled = true;
            emailInput.disabled = true;
            apiKeyButton.disabled = true;
            apiKeyButton.textContent = 'è¨­å®šä¸­...';
            
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        google.script.run.registerForEmailAnalysis(apiKeyValue, emailValue);
                        localStorage.setItem('koi_apiKey', apiKeyValue);
                        localStorage.setItem('koi_email', emailValue);
                        showScreen(mainAppScreen);
                    } else {
                        messageEl.textContent = response.message || 'APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚';
                        messageEl.classList.remove('hidden');
                        apiKeyInput.disabled = false;
                        emailInput.disabled = false;
                        apiKeyButton.disabled = false;
                        apiKeyButton.textContent = 'è¨­å®šã‚’ä¿å­˜ã—ã¦å§‹ã‚ã‚‹';
                    }
                })
                .withFailureHandler(function(err) {
                    messageEl.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + err.message;
                    messageEl.classList.remove('hidden');
                    apiKeyInput.disabled = false;
                    emailInput.disabled = false;
                    apiKeyButton.disabled = false;
                    apiKeyButton.textContent = 'è¨­å®šã‚’ä¿å­˜ã—ã¦å§‹ã‚ã‚‹';
                })
                .testAndSaveApiKey(apiKeyValue);
        }
        
        function handleDiagnosis() {
            if (!document.getElementById('your-name').value || !document.getElementById('partner-name').value || !document.getElementById('talk-data').value) {
                alert('åå‰ã¨ãƒˆãƒ¼ã‚¯å±¥æ­´ã¯å¿…é ˆã§ã™ã€‚');
                return;
            }

            resultContainer.classList.add('hidden');
            showLoading(true);

            // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‚’å–å¾—
            const charSelect = document.getElementById('character');
            currentCharacter = charSelect.options[charSelect.selectedIndex].text;

            const formData = {
                userId: currentUserId, 
                character: currentCharacter,
                tone: document.getElementById('tone').value,
                yourName: document.getElementById('your-name').value,
                partnerName: document.getElementById('partner-name').value,
                counselingText: document.getElementById('counseling-text').value,
                talkData: document.getElementById('talk-data').value,
            };

            google.script.run
                .withSuccessHandler(onDiagnosisSuccess)
                .withFailureHandler(onDiagnosisFailure)
                .runDiagnosis(formData);
        }

        function handlePdfDownload() {
            const btn = document.getElementById('pdf-button');
            btn.textContent = 'PDFã‚’ç”Ÿæˆä¸­...';
            btn.disabled = true;

            // â˜…ã‚°ãƒ©ãƒ•ç”»åƒã‚’å–å¾—ã—ã¦ã‹ã‚‰GASã¸é€ä¿¡
            if (currentChartObject) {
                const imgUri = currentChartObject.getImageURI();
                // data:image/png;base64, ã‚’å‰Šé™¤ã—ã¦ç´”ç²‹ãªBase64æ–‡å­—åˆ—ã«ã™ã‚‹
                const base64Img = imgUri.replace("data:image/png;base64,", "");
                
                google.script.run
                    .withSuccessHandler(onPdfSuccess)
                    .withFailureHandler(onPdfFailure)
                    .createPdfReport(currentAiResponse, currentCharacter, base64Img);
            } else {
                // ã‚°ãƒ©ãƒ•ãŒãªã„å ´åˆã¯ç”»åƒãªã—ã§ç”Ÿæˆ
                google.script.run
                    .withSuccessHandler(onPdfSuccess)
                    .withFailureHandler(onPdfFailure)
                    .createPdfReport(currentAiResponse, currentCharacter, null);
            }
        }

        function onPdfSuccess(base64Pdf) {
            const btn = document.getElementById('pdf-button');
            const link = document.createElement('a');
            link.href = 'data:application/pdf;base64,' + base64Pdf;
            link.download = 'æ‹ã®é‘‘å®šæ›¸.pdf';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            btn.textContent = 'ğŸ“„ é‘‘å®šæ›¸ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            btn.disabled = false;
        }

        function onPdfFailure(err) {
            alert('PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
            const btn = document.getElementById('pdf-button');
            btn.textContent = 'ğŸ“„ é‘‘å®šæ›¸ã‚’PDFã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
            btn.disabled = false;
        }
        
        function onDiagnosisSuccess(result) {
            showLoading(false);
            if (result.success) {
                currentAiResponse = result.aiResponse;
                const formattedHtml = parseMarkdown(result.aiResponse);
                resultArea.innerHTML = formattedHtml;
                
                resultContainer.classList.remove('hidden');
                document.getElementById('pdf-button').classList.remove('hidden');

                if (result.chartData && result.chartData.labels && result.chartData.labels.length > 0) {
                    drawChart(result.chartData);
                } else {
                    chartContainer.innerHTML = ""; // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ã‚¯ãƒªã‚¢
                    currentChartObject = null;
                }
            } else {
                onDiagnosisFailure(result.error);
            }
        }

        function onDiagnosisFailure(error) {
            showLoading(false);
            alert('é‘‘å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error);
        }

        google.charts.load('current', {'packages':['corechart']});
        
        function drawChart(chartData) {
            const dataForChart = [['æ—¥ä»˜', 'æ¸©åº¦']];
            chartData.labels.forEach((label, index) => {
                dataForChart.push([label, chartData.values[index]]);
            });

            const data = google.visualization.arrayToDataTable(dataForChart);
            
            // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’å–å¾—
            const color = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();

            const options = {
                title: 'äºŒäººã®æ‹ã®æ¸©åº¦ã‚°ãƒ©ãƒ•',
                hAxis: { title: 'æ—¥ä»˜', titleTextStyle: { color: '#333' } },
                vAxis: { minValue: 0 },
                legend: { position: 'none' },
                colors: [color], // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨
                backgroundColor: 'transparent' // èƒŒæ™¯é€é
            };
            
            const chartDiv = document.getElementById('chart-container');
            currentChartObject = new google.visualization.AreaChart(chartDiv);
            currentChartObject.draw(data, options);
        }
    </script>
</body>
</html>
